from __future__ import unicode_literals

# import os.path

import mock

import pafy

import pytest

import vcr

from mopidy_youtube import youtube


@pytest.yield_fixture
def pafy_mock():
    patcher = mock.patch.object(youtube, 'pafy', spec=pafy)
    yield patcher.start()
    patcher.stop()


@pytest.fixture
def pafy_mock_with_video(pafy_mock):
    video_mock = pafy_mock.new.return_value
    video_mock.bigthumb = 'big thumb'
    video_mock.bigthumbhd = 'big thumb in hd'
    video_mock.getbestaudio.return_value.url = 'http://example.com/'
    video_mock.length = 2000
    video_mock.title = 'a title'
    video_mock.videoid = 'a video id'

    return pafy_mock


@vcr.use_cassette('tests/fixtures/youtube_playlist.yaml')
def test_get_playlist():

    youtube.API.search_results = 10
    youtube.Playlist.max_videos = 20
    youtube.API.youtube_api_key = 'mock_api_key_for_tests'
    youtube.ThreadPool.threads_max = 2

    pl = youtube.Playlist.get('PLOxORm4jpOQfMU7bpfGCzDyLropIYEHuR')

    assert len(pl.videos.get()) == 20
    return
    assert pl.videos.get()[0].title.get()

    # Playlist.videos starts loading video info in the background
    video = pl.videos.get()[0]
    assert video._length                # should be ready
    assert video.length.get() == 400

    pl2 = youtube.Playlist.get('PLOxORm4jpOQfMU7bpfGCzDyLropIYEHuR')

    assert pl2 is pl                    # fetch from cache
    assert pl._videos                   # should be ready


@vcr.use_cassette('tests/fixtures/youtube_search.yaml')
def test_search():

    youtube.API.search_results = 10
    youtube.Playlist.max_videos = 20
    youtube.API.youtube_api_key = 'mock_api_key_for_tests'
    youtube.ThreadPool.threads_max = 2

    videos = youtube.Entry.search('chvrches')

    assert len(videos) == 10
    assert videos[0]._title             # should be ready
    assert videos[0]._channel           # should be ready

    video = youtube.Video.get('e1YqueG2gtQ')

    assert video in videos              # cached


@vcr.use_cassette('tests/fixtures/youtube_get_video.yaml')
def test_get_video():

    youtube.API.search_results = 15
    youtube.Playlist.max_videos = 20
    youtube.API.youtube_api_key = 'mock_api_key_for_tests'
    youtube.ThreadPool.threads_max = 2

    video = youtube.Video.get('e1YqueG2gtQ')

    assert video.length.get()

    # get again, should fetch from cache, _length should be ready
    video2 = youtube.Video.get('e1YqueG2gtQ')

    assert video2 is video
    assert video2._length


def test_audio_url(pafy_mock_with_video):

    youtube.API.search_results = 15
    youtube.Playlist.max_videos = 20
    youtube.API.youtube_api_key = 'mock_api_key_for_tests'
    youtube.ThreadPool.threads_max = 2

    video = youtube.Video.get('e1YqueG2gtQ')

    assert video.audio_url.get()


def test_audio_url_fail(pafy_mock):
    pafy_mock.new.side_effect = Exception('Removed')

    youtube.API.search_results = 15
    youtube.Playlist.max_videos = 20
    youtube.API.youtube_api_key = 'mock_api_key_for_tests'
    youtube.ThreadPool.threads_max = 2

    video = youtube.Video.get('unknown')

    assert not video.audio_url.get()
